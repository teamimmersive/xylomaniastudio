<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Xylomania Studio | Kenichi KOGA</title>
  <meta name="theme-color" content="#ffffff" />
  <link rel="icon" href="assets/logo.png" />
  <style>
    :root {
      --bg: #ffffff;
      --card: #f8f8f8;
      --text: #222222;
      --muted: #555555;
      --accent: #333333;
      --line: #dddddd;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: "Noto Sans JP", system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }

    header {
      padding: 40px 20px 18px;
      text-align: center;
    }
    .logo { width: min(520px,82vw); height: auto; }

    .sub {
      margin-top: 10px;
      font-size: 0.95rem;
      color: var(--muted);
    }

    .wrap {
      max-width: 740px;
      margin: 0 auto;
      padding: 12px 16px 80px;
    }

    .toolbar {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      align-items: center;
      margin: 6px 0 16px;
    }
    .select {
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 8px 10px;
    }

    .section {
      margin: 18px 0 8px;
      padding: 8px 4px;
      border-top: 1px solid var(--line);
      color: var(--muted);
      font-size: 0.9rem;
    }

    .grid{display:grid;grid-template-columns:1fr;gap:12px}
@media (min-width:560px){ .grid{grid-template-columns:1fr} }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 14px;
      display: flex;
      gap: 12px;
      align-items: center;
      transition: background 0.2s ease;
    }
    .card:hover { background: #eee; }

    .left {
      display: flex;
      gap: 12px;
      align-items: center;
      min-width: 0;
    }

    .emoji { font-size: 1.25rem; line-height: 1; }

    a.title-link {
      text-decoration: none;
      color: var(--text);
      display: block;
      flex: 1;
    }

    .title {
      font-size: 1.02rem;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .note {
      font-size: 0.86rem;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .btn {
      flex-shrink: 0;
      display: inline-block;
      padding: 10px 14px;
      border-radius: 10px;
      background: var(--accent);
      color: #fff;
      text-decoration: none;
      font-weight: 600;
      transition: transform .12s ease, filter .12s ease;
    }
    .btn:hover { transform: translateY(-1px); filter: brightness(0.9); }

    footer {
      margin: 28px 0 40px;
      text-align: center;
      color: var(--muted);
      font-size: 0.85rem;
    }

    .diag {
      position: fixed;
      left: 12px;
      right: 12px;
      bottom: 12px;
      max-width: 740px;
      margin: 0 auto;
      background: #f1f1f1;
      border: 1px solid var(--line);
      color: #666;
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <header>
    <img id="logo" src="assets/logo.png" class="logo" alt="Xylomania Studio ロゴ">
    <div class="sub">Kenichi KOGA</div>
  </header>

  <div class="wrap">
    <div class="toolbar">
      <select id="groupFilter" class="select" aria-label="グループで絞り込み">
        <option value="">すべて表示</option>
      </select>
    </div>

    <div id="content" aria-live="polite"></div>

    <footer>© 2025 Xylomania Studio / Kenichi KOGA</footer>
  </div>

  <div id="diag" class="diag" role="status" aria-live="polite">準備中…</div>

<script>
  // 公開CSV
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTXGWHo3tYmufoXCj4tLN7Selc6FLuHz29299EddOOiO6M15aspdLsiBKUIb_4V21owhBwMyreD87nv/pub?gid=0&single=true&output=csv";
  const diag = (m)=>{ document.getElementById('diag').textContent = m; console.log(m); };

  // 見出しゆらぎ吸収
  function norm(h){ return String(h||"").toLowerCase()
    .replace(/\s+/g,"").replace(/[＿‐ー−―\-]/g,"-").replace(/[：:]/g,":").replace(/[（）()\u3000]/g,""); }
  const HEADER_ALIASES = {
    "title":"title","name":"title","タイトル":"title","題名":"title","名称":"title",
    "url":"url","link":"url","リンク":"url",
    "group":"group","グループ":"group","カテゴリ":"group","カテゴリー":"group","区分":"group",
    "emoji":"emoji","絵文字":"emoji","アイコン":"emoji",
    "enabled":"enabled","表示":"enabled","有効":"enabled","公開":"enabled",
    "order":"order","順序":"order","並び順":"order","ソート":"order",
    "note":"note","メモ":"note","注記":"note","備考":"note","説明":"note"
  };
  function mapHeaderKeys(headers){
    return headers.map(raw=>{
      const h = norm(raw);
      for(const [k,v] of Object.entries(HEADER_ALIASES)){ if(norm(k)===h) return v; }
      return String(raw).trim().toLowerCase();
    });
  }

  // CSV取得 & パース
  async function fetchCSV(u){ const r=await fetch(u+"&cb="+Date.now(),{cache:"no-store"}); if(!r.ok) throw new Error("CSV fetch failed:"+r.status); return r.text(); }
  function parseCSV(t){
    const rows=[]; let row=[],cell="",q=false;
    for(let i=0;i<t.length;i++){
      const c=t[i],n=t[i+1];
      if(c==='\"'&&!q){q=true;continue;}
      if(c==='\"'&&q){ if(n==='\"'){cell+='\"';i++;continue;} q=false;continue; }
      if(c===','&&!q){row.push(cell);cell="";continue;}
      if((c==='\n'||c==='\r')&&!q){ if(cell.length||row.length){row.push(cell);rows.push(row);row=[];cell="";} continue;}
      cell+=c;
    }
    if(cell.length||row.length){row.push(cell);rows.push(row);}
    return rows;
  }

  // 行→オブジェクト（元シートの行番号を保持）
  function toObjects(rows){
    const headerRaw=(rows.shift()||[]).map(h=>h.trim());
    const header=mapHeaderKeys(headerRaw);
    return rows.map((r,i)=>r&&r.some(v=>String(v).trim()!=="")?{r,i}:null).filter(Boolean)
      .map(({r,i})=>{const o={}; header.forEach((h,idx)=>o[h]=(r[idx]||"").trim()); o.__idx=i; return o;});
  }

  // 数値化（全角/「1位」/「#1」等もOK）
  function toNumOrNull(v){
    const s=String(v??"").replace(/[０-９]/g,d=>String.fromCharCode(d.charCodeAt(0)-0xFEE0)).replace(/[^\d\-]/g,"").trim();
    if(s==="") return null; const n=Number(s); return Number.isFinite(n)?n:null;
  }
  function truthy(v){ const s=String(v||"").trim().toLowerCase(); return !(s==="false"||s==="no"||s==="0"||s==="off"||s==="×"||s==="ng"); }

  // 正規化
  function normalize(items){
    return items.map(x=>({
      title:x.title||"", url:x.url||"", group:x.group||"Links", emoji:x.emoji||"",
      enabled:truthy(x.enabled), order:toNumOrNull(x.order), note:x.note||"", index:x.__idx
    }))
    .filter(x=>x.title&&x.url&&x.enabled);
  }

  // ★グローバルに「順序の昇順 → 行順」で並べる（グループは“切れ目見出し”として挿入）
  function sortGlobal(items){
    const hasOrder = items.some(it=>it.order!==null);
    return items.slice().sort((a,b)=>{
      if(hasOrder){
        const ao=(a.order===null?Number.POSITIVE_INFINITY:a.order);
        const bo=(b.order===null?Number.POSITIVE_INFINITY:b.order);
        if(ao!==bo) return ao-bo;       // 順序の昇順
        return a.index-b.index;         // 同値は元の行順
      }else{
        return a.index-b.index;         // すべて空なら行順
      }
    });
  }

  // グローバル順に出力しつつ、グループが変わる所だけ見出しを入れる
  function renderGlobal(sorted, filter=""){
    const root=document.getElementById("content"); root.innerHTML="";
    let cur=null, grid=null;
    sorted.forEach(item=>{
      if(filter && item.group!==filter) return;
      if(item.group!==cur){
        cur=item.group;
        const section=document.createElement("div");
        const h=document.createElement("div"); h.className="section"; h.textContent=cur; section.appendChild(h);
        grid=document.createElement("div"); grid.className="grid"; section.appendChild(grid);
        root.appendChild(section);
      }
      const card=document.createElement("div"); card.className="card";
      const left=document.createElement("div"); left.className="left";
      if(item.emoji){ const em=document.createElement("div"); em.className="emoji"; em.textContent=item.emoji; left.appendChild(em); }
      const link=document.createElement("a"); link.href=item.url; link.target="_blank"; link.rel="noopener"; link.className="title-link";
      const ttl=document.createElement("div"); ttl.className="title"; ttl.textContent=item.title; link.appendChild(ttl);
      if(item.note){ const note=document.createElement("div"); note.className="note"; note.textContent=item.note; link.appendChild(note); }
      left.appendChild(link); card.appendChild(left); grid.appendChild(card);
    });
  }

  function fillFilterFrom(sorted){
    const sel=document.getElementById("groupFilter"); const current=sel.value;
    sel.innerHTML='<option value="">すべて表示</option>';
    // グループは“最初に現れた順”
    const seen=new Set();
    sorted.forEach(it=>{ if(!seen.has(it.group)){ seen.add(it.group); const opt=document.createElement("option"); opt.value=it.group; opt.textContent=it.group; sel.appendChild(opt);} });
    sel.value=current||"";
  }

  async function main(){
    try{
      diag("CSVを取得中…");
      const raw=await fetchCSV(CSV_URL);
      diag("CSVを解析中…");
      const rows=parseCSV(raw);
      const objs=toObjects(rows);
      const items=normalize(objs);
      const sorted=sortGlobal(items);
      if(sorted.length===0){ diag("有効な行が見つかりません。"); } else { diag(`${sorted.length}件のリンクを読み込みました。`); }
      fillFilterFrom(sorted);
      renderGlobal(sorted);
      document.getElementById("groupFilter").addEventListener("change",e=>renderGlobal(sorted, e.target.value));
    }catch(e){
      diag("読み込みに失敗：CSVの公開設定やURLをご確認ください。"); console.error(e);
    }
  }
  (function(){ try{ main(); }catch(e){ diag("初期化エラー："+e.message); console.error(e);} })();
</script>


</body>
</html>
